---
title: 求求你们了，别再重复造轮子了，一个 Spring 注解轻松搞定循环重试功能！
tags: JK
excerpt: Retryable
---




> 哈喽，你好呀，我是了不起，一个奔3的程序员~ 
>
> 每周定时更新一些程序员相关的技术和文章，欢迎读者小伙伴们积极留言探讨呀~

最近了不在做一个推送数据的功能！

对方要求在推送失败后，重试几次！

了不起为了快速给他搞完，就...

后来想了想，这种问题应该比较常见。

于是在网好好找了一番，看看有没有合适的工具！

### Retryable

Retryable是Spring框架中的一个注解，它可以让我们在方法执行失败时自动重试。

在实际开发中，我们经常会遇到一些网络不稳定或者其他原因导致方法执行失败的情况。如果我们手动去处理这些异常，会非常繁琐和耗时。而Retryable注解可以帮助我们自动处理这些异常，让我们的代码更加简洁和高效。



 下面我们来详细了解一下Retryable注解的使用方法： 

1. 引入Spring Retry依赖 首先，我们需要在项目中引入Spring Retry依赖，以便能够使用Retryable注解。

在Maven项目中，我们可以在pom.xml文件中添加如下依赖：

```xml
<dependency>
   <groupId>org.springframework.retry</groupId>
   <artifactId>spring-retry</artifactId>
   <version>${spring-retry.version}</version>
</dependency>
```

2. 配置Retryable注解 在使用Retryable注解之前，我们需要在Spring的配置文件中进行一些基本配置。 

在配置文件中添加以下代码：

```java
@EnableRetry
@SpringBootApplication
public class RetryDemoApplication {
    public static void main(String[] args) {
        SpringApplication.run(RetryDemoApplication.class, args);
  }
}
```

或者用注解来配置 @Configuration和@EnableRetry注解的使用。 

```java

@Configuration
@EnableRetry
public class RetryConfig {

}
```

3. 使用Retryable注解 

```java
//IO异常
@Retryable(value = {IOException.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void doSomething() throws IOException {
   // ...
}
这里我们指定了重试的异常类型为BizException，并且最多重试3次，每次重试之间的间隔为1秒钟。 

```

 这里我们指定了重试的异常类型为IOException，并且最多重试3次，每次重试之间的间隔为1秒钟。

参数的含义：

- value：抛出指定异常才会重试
- include：和value一样，默认为空，当exclude也为空时，默认所有异常
- exclude：指定不处理的异常
- maxAttempts：最大重试次数，默认3次
- backoff：重试等待策略

 使用自定义的异常RetryException也是可以的。 

```java
@Retryable(value = {BizRetryException.class}, maxAttempts = 3, backoff = @Backoff(delay = 1000))
public void doSomething() throws BizRetryException {
   // ...
}
```

4. 自定义RetryPolicy 

 有时候，默认的重试策略可能并不能满足我们的需求。这时，我们可以自定义一个自己的RetryPolicy。例如，在进行数据库操作时，我们希望在发生死锁时进行重试，我们可以编写一个自定义的RetryPolicy，代码如下： 

```java
class BizRetryPolicy extends SimpleRetryPolicy {

   public BizRetryPolicy(int maxAttempts, Map<Class<? extends Throwable>, Boolean> retryableExceptions) {
       super(maxAttempts, retryableExceptions);
   }

   @Override
   public RetryContext open(RetryContext parent) {
       //...
       return new BizRetryPolicyContext(parent);
   }
}

class BizRetryPolicyContext extends RetryContextSupport {
	//...
} 
```

 然后在使用Retryable注解时指定自定义的RetryPolicy即可，例如： 

```java
@Retryable(value = {BizRetryException.class}, maxAttempts = 3, retryPolicyClass = BizRetryPolicy.class) 
public void doSomething() throws BizRetryException { 
    // ... 
} 
```



5. 使用Recover注解 

当重试耗尽时还是失败，会出现什么情况呢？

我们可能需要采取一些恢复措施或打印日志来提醒用户或管理员。这时，我们可以在方法上添加@Recover注解，它可以指定方法在所有重试尝试失败后执行。 例如，假设我们想要在所有重试尝试都失败之后打印一条日志，我们可以添加以下方法： 

```java
@Recover
public void recover(BizRetryException e) {
   logger.error("All attempts failed, could not perform operation: {}", e.getMessage());
}
```

 这里我们指定了Recover注解的属性为BizRetryException.class，表示如果发生BizRetryException异常，就执行该方法。 

### 总结

 Retryable注解是Spring框架中非常实用的功能之一，它可以帮助我们更加方便地进行方法重试，从而使得我们的程序更加健壮和鲁棒。在使用Retryable注解时，需要注意参数的配置和自定义RetryPolicy的编写。如果使用得当，Retryable注解可以帮助我们大大提高程序的稳定性和可靠性。 

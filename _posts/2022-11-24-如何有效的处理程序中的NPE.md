---
title: 如何有效的处理程序中的NPE
tags: JK
excerpt: Optional
---
> 哈喽，大家好，我是程小南，导航搬砖工一名，致力于为大家淘出更多有趣好使的生产力工具！

相信不少小伙伴跟小南一样。

被java的NPE(Null Pointer Exception)所谓的空指针异常搞的头昏脑涨。

如何有效“防止 NPE“，是程序员的必备修养。

今天就利用Java8的新特性 Optional来尽量简化代码同时高效处理NPE(Null Pointer Exception 空指针异常)。

### 初识Optional

 从Java 8引入的一个很有趣的特性是Optional类。Optional类主要解决的问题是臭名昭著的空指针异常（NullPointerException）。 简单来说，Opitonal类就是Java提供的为了解决大家平时判断对象是否为空用。它的存在可以让代码更加简单，可读性跟高，代码写起来更高效。下面，我们就高效的学习一下神奇的Optional类！

### Optional的使用

以下所有例子中使用的对象

```java
public class Car{
    //省略get,set
    private String color;
    private String brand;
    public Car(String color, String brand) {
        this.color = color;
        this.brand = brand;
    }
    public Car() {
    }
}
```

#### Optional对象创建

Java程序语言创建对象基本就是根据构造函数去`new`

首先我们先查看Optional的内部源码,分析提取出创建Optional对象的方法

```java
public final class Optional<T> {
    private static final Optional<?> EMPTY = new Optional<>();
    private final T value;
   //可以看到两个构造方格都是private 私有的。没办法new出Optional对象  
    private Optional() {
        this.value = null;
    }
    private Optional(T value) {
        this.value = Objects.requireNonNull(value);
    }
    //静态方法
    //创建出一个包装值为空的一个对象因为没有任何参数赋值
    public static <T> Optional<T> empty() {
        @SuppressWarnings("unchecked") Optional<T> t = (Optional<T>) EMPTY;
        return t;
    }
    //创建出一个包装值非空的一个对象 因为做了赋值
    public static <T> Optional<T> of(T value) {
        return new Optional<>(value);
    }
    //如果参数value为空，则创建空对象，如果不为空，则创建有参对象
    public static <T> Optional<T> ofNullable(T value) {
        return value == null ? empty() : of(value);
    }
}


```

根据API创建获取Optional

```java
// 1、创建对象值为空的Optional对象        
 Optional<Car> optEmpty = Optional.empty();
// 2、创建包装对象值非空的Optional对象        
Optional<Car> optOf = Optional.of(new Car("White","BYD"));
// 3、创建包装对象值允许为空也可以不为空的Optional对象        
Optional<Car> optOfNullable1 = Optional.ofNullable(null);
Optional<Car> optOfNullable2 = Optional.ofNullable(new Car("White","BYD"));
```

#### Optional.isPresent()方法(判读是否为空)

```java
 public boolean isPresent() {  
     return value != null;   
 }
```

示例：

```java
Car car = new Car("White","BYD")
//不使用Optional
if(car == null){
    //写为空的逻辑 
} else {
    //写不为空的逻辑
}
//使用Optional
if (Optional.ofNullable(car).isPresent()){ 
    //写不为空的逻辑              
}else{
   //写为空的逻辑      
}
```

#### Optional.get()方法(返回对象的值)

能放就能拿，不然就有点流氓了。

```java
public T get() {
   if (value == null) {
     throw new NoSuchElementException("No value present");
   }
   return value;
}
```

也就是如果value不为空则做返回，如果为空则抛出异常 `NoSuchElementException`常常配合Optional.isPresent()方法使用。

#### Optional.ifPresent()方法(判读是否为空并返回函数)

如果对象非空，则运行函数体，源码:

```java
public void ifPresent(Consumer<? super T> consumer) { 
  //如果value不为空，则运行accept方法体        
  if (value != null)            
  consumer.accept(value); 
}
```

示例：

```java
Car car = new Car("White","BYD")
Optional.ofNullable(car).ifPresent(
    c -> {
        System.out.println("品牌："+ c.getBrand());
        System.out.println("颜色："+ c.getColor());
    }
 );
```

如果对象不为空，则会打印这个车的品牌和颜色信息，因为内部已经做了NPE（非空判断），所以就不用担心空指针异常了

#### Optional.orElse()方法(为空返回对象)

常用方法之一。

如果包装对象为空的话，就执行orElse方法里的other，如果非空，则返回写入对象,源码:

```java
public T orElse(T other) {
    //如果非空，返回value，如果为空，返回other 
    return value != null ? value : other;
}  
```

示例：

```java
Car car = new Car("White","BYD")
Optional.ofNullable(car).orElse(new Car("Red","BYD"));
```

#### Optional.orElseGet()方法(为空返回Supplier对象)

这个与orElse很相似，入参不一样，入参为Supplier对象，为空返回传入对象的.get()方法，如果非空则返回当前对象,源码:

```java
public T orElseGet(Supplier<? extends T> other) {
    return value != null ? value : other.get();
}
```

示例：

```java
Optional<Supplier<Car>> sup = Optional.ofNullable(new Car("White","BYD"));
//调用get()方法，此时才会调用对象的构造方法，即获得到真正对象
Optional.ofNullable(car).orElseGet(sup.get());
```

Supplier也是创建对象的一种方式,简单来说，Suppiler是一个函数式接口，主要功能懒加载，声明之后并不会占用内存，只有执行了get()方法之后，才会调用构造方法创建出对象

#### Optional.orElseThrow()方法(为空返回异常)

这个我个人在实战中也经常用到这个方法，方法作用的话就是如果为空，就抛出你定义的异常，如果不为空返回当前对象，在实战中所有异常肯定是要处理好的，为了代码的可读性，源码：

```java
public <X extends Throwable> T orElseThrow(Supplier<? extends X> exceptionSupplier) throws X {
    if (value != null) {
        return value;
    } else {
        throw exceptionSupplier.get();
    }
}
```

示例：

```java
//一般配合从某个地方获取到对象，查询数据库，第三方接口，这里接new了
Car car = new Car("White","BYD")
Optional.ofNullable(car).orElseThrow(() -> new BizException("抛出没有对象的异常"));
```

####  Optional.filter()方法(过滤对象)

filter()方法，接收一个对象，对他进行条件过滤，如果条件符合则返回Optional对象本身，如果不符合则返回空Optional，源码：

```java
public Optional<T> filter(Predicate<? super T> predicate) {
    Objects.requireNonNull(predicate);
    //如果为空直接返回this
    if (!isPresent())
        return this;
    else
         //判断返回本身还是空Optional
        return predicate.test(value) ? this : empty();
}
```

示例：

```java
Car car = new Car("White","BYD")
Optional.ofNullable(car).filter(c -> "BYD".equals(c.getBrand()));
```

#### Optional.map()方法(对象二次包装)

map()方法将对应Funcation函数式接口中的对象，进行二次运算，封装成新的对象然后返回在Optional中，源码：

```java
public<U> Optional<U> map(Function<? super T, ? extends U> mapper) {
    Objects.requireNonNull(mapper);
    //如果为空返回空Optional对象
    if (!isPresent())
        return empty();
    else {
        //否则返回用方法修饰过的Optional
        return Optional.ofNullable(mapper.apply(value));
    }
}
```

示例：

```java
 String barnd = Optional.ofNullable(car).map(c -> c.getBrand()).orElse("品牌为空");
```

#### Optional使用注意事项

Optional真么好用，真的可以完全替代if判断吗？

我想这肯定是大家使用完之后Optional之后可能会产生的想法，答案是否定的

示例：

```java
Car car = new Car("White","BYD")
//普通判断
if(StringUtils.isEmpty(car.getBrand())){ 
   //品牌为空执行代码块
}
//使用Optional做判断
Optional.ofNullable(car).map(c -> c.getBrand()).orElse("品牌为空");
```

判断对象属性这一个简单判断，如果用了Optional我们还需要考虑包装值，考虑代码书写，考虑方法调用等！可读性并不好，感觉比较呆。

#### 小结

具体要怎么用，要根据业务场景以及代码规范来定义。实战场景还有很多，包括return时可以判断是否返回当前值还是跳转到另一个方法体中，什么的还有很多，欢迎大家留言讨论

### 好消息

时隔2个月，摸鱼群再次限时开放了。

![](https://navtool.gitee.io/blog/assets/imgs/20221027/111.jpg)

程序员指南读者交流群（摸鱼、白嫖技术课程为主），又不定时开放了，感兴趣的朋友，下方公号内回复：`666`。

![](https://navtool.gitee.io/blog/assets/imgs/erweima.jpg)

>  我是程小南,感谢各位童鞋的：点赞、收藏和在看，我们下期更精彩！
